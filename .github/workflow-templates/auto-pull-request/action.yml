name: auto-pull-request
description: Automatically creates and merges pull requests with automerge label

inputs:
  branch:
    description: "Designated branch name"
    required: true
  gh_token:
    description: "GitHub token"
    required: true

runs:
  using: "composite"
  steps:
    - name: Ensure automerge label exists
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
      run: |
        gh label create automerge \
          --description "Default label for automerge action" \
          --color 0000FF \
          --force

    - name: Check if PR exists
      id: check_pr
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
      run: |
        # List open pull requests targeting designated branch
        PR_EXISTS=$(gh pr list \
          --state open \
          --base "${{ inputs.branch }}" \
          --head main \
          --json number \
          --jq '.[].number')
        # Capture PR number if PR exists
        echo "PR_EXISTS=$PR_EXISTS" >> $GITHUB_ENV

    - name: Raise Pull Request
      id: create-pr
      if: env.PR_EXISTS == ''
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.gh_token }}
      run: |
        # Create pull request from main into designated branch with label automerge
        PR=$(gh pr create \
          --title "Auto-sync ${{ inputs.branch }} branch from main" \
          --body "Auto-generated by GitHub Actions" \
          --base "${{ inputs.branch }}" \
          --label automerge \
          --head main)
        # Capture PR number
        echo "PR_NUMBER=$(basename "$PR")" >> $GITHUB_ENV

    - name: Attempt auto-merge
      id: automerge
      uses: "pascalgn/automerge-action@v0.15.6"
      env:
        MERGE_ERROR_FAIL: true
        GITHUB_TOKEN: "${{ inputs.gh_token }}"
        PULL_REQUEST: ${{ env.PR_EXISTS || env.PR_NUMBER }}
